{% extends 'core/base.html' %}

{% load static%}

{% block contenido%}
<div class="container-fluid py-5" id="lista-productos">
<div class="container-fluid carrusel">
    <h3 class="py-4">Productos Destacados</h3>
    <div class="glide">
      <div class="glide__track" data-glide-el="track">
        <ul class="glide__slides">
          {% for p in productos%}
            <li class="glide__slide">
              <img src="{{p.imagen.url}}" alt="..." class="img-responsive w-50">
              <p class="nombre_prod">{{p.nombre}}</p>
              <p><small class="id_prod">{{p.id_producto}}</small></p>
              <hr>
              <p><small class="stock_prod">Quedan: {{p.stock}}</small></p>
              <p><small class="">Precio: <span class="precio_prod">{{p.precio}}</span></small></p>
              <hr>
              <a href="#" class="text-dark agregar-carrito">Agregar Al Carrito</a>
            </li>
          {% endfor%}
        </ul>
      </div>

    </div>
    </div>

    <h3 class="py-4">Categorias</h3>
    <h5>CERRADURAS</h5>

    <div class="row p-3"> 

      {%for c in prod_tipo_cerradura%}
      <div class="col-lg-3 p-1">
        <img src="{{c.imagen.url}}" alt="..." class="img-responsive w-100">
        <p class="nombre_prod">{{c.nombre}}</p>
        <p><small class="id_prod">{{c.id_producto}}</small></p>
        <hr>
        <p><small class="stock_prod">Quedan: {{c.stock}}</small></p>
        <p><small class="">Precio: <span class="precio_prod">{{c.precio}}</span></small></p>
        <hr>
        <a href="#" class="boton-carrito text-dark agregar-carrito">Agregar Al Carrito</a>
      </div>
      {%endfor%}

    </div>

    <h5 class="py-5">HERRAMIENTAS MANUALES</h5>

    <div class="row p-3"> 
      {% for h in prod_herramientas_manuales%}
        <div class="col-lg-3 p-1">
          <img src="{{h.imagen.url}}" alt="..." class="img-responsive w-100">
          <p class="nombre_prod">{{h.nombre}}</p>
          <p><small class="id_prod">{{h.id_producto}}</small></p>
          <hr>
          <p><small class="stock_prod">Quedan: {{h.stock}}</small></p>
          <p><small>Precio: <span class="precio_prod">{{h.precio}}</span></small></p>
          <a href="#" class="boton-carrito text-dark agregar-carrito">Agregar Al Carrito</a>
        </div>
      {%endfor%}

    </div>

    
  </div>
{%endblock%}

{%block js%}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
<script>
        
    const config1 = {
      autoplay:1300,
      type:'carousel', 
      perView: 5
    }
    new Glide('.glide', config1).mount()

    const config2 = {
      autoplay:1500,
      type:'carousel', 
      perView: 4
    }
    new Glide('.glide2', config2).mount()

</script>

<script>

  const carrito = document.getElementById('carrito');
  const lista_productos_carrito = document.querySelector('#lista-carrito tbody'); 
  const productos = document.getElementById('lista-productos');
  const vaciarCarritoBtn = document.getElementById('vaciar-carrito'); 

  cargarEventListeners(); 


  function cargarEventListeners(){
      //Al cargar el documento, mostrar productos desde locals
      document.addEventListener('DOMContentLoaded', leerLocalStorage)

      productos.addEventListener('click', comprarProducto); 

        //Cuando se elimina un producto del carrito
      carrito.addEventListener('click', eliminarProductoDeCarrito);

      vaciarCarritoBtn.addEventListener('click', vaciarCarrito);

  }

  function comprarProducto(e){
    e.preventDefault();

    //Delegation para agregar-carrito
    if(e.target.classList.contains('agregar-carrito')){
        const producto = e.target.parentElement;

        leerDatosProducto(producto);
    }
}

function leerDatosProducto(producto){

const infoProducto = {
    imagen: producto.querySelector('img').src, 
    nombre_producto: producto.querySelector('.nombre_prod').textContent, 
    id_producto : producto.querySelector('.id_prod').textContent, 
    stock_producto: producto.querySelector('.stock_prod').textContent, 
    precio_producto: producto.querySelector('.precio_prod').textContent
}


insertarProductoAlCarrito(infoProducto);
}

function insertarProductoAlCarrito(infoProducto){
    const row = document.createElement('tr');

    row.innerHTML = `
        <td> <img src="${infoProducto.imagen}" width="70px">  </td>
        <td><small>${infoProducto.id_producto}</small></td>
        <td><small>${infoProducto.nombre_producto}</small></td>
        <td><small>${infoProducto.precio_producto}</small></td>
        <td>
            <a href="#" class="borrar-curso-carrito" data-id="${infoProducto.id_producto}">X</a>
        </td>
        <td></td>
    `;

    lista_productos_carrito.appendChild(row);

    //Guardar en localstorage

    guardarProductoLocalStorage(infoProducto);

    Swal.fire({
                title: 'Espera un momento !',
                html: 'AÃ±adiendo a Carrito',// add html attribute if you want or remove
                allowOutsideClick: false,
                onBeforeOpen: () => {
                    Swal.showLoading()
                },
            });

    setTimeout(() => {
      Swal.fire(
        'Perfecto!',
        'Tu Producto fue agregado al carrito! <hr><small>Revisalo en el icono del carrito <img src="{%  static "core/img/cart.png" %}" id="img-carrito" width="18px"><small>',
        'success'
      )
    }, 1000);
}

function guardarProductoLocalStorage(infoProducto){
    let productos;

    productos = obtenerProductosLocalStorage();
    productos.push(infoProducto);

    //El producto seleccionado se agrega a locals
    localStorage.setItem('productos', JSON.stringify(productos))
}

  function vaciarCarrito(e){

  while(lista_productos_carrito.firstChild){
      lista_productos_carrito.removeChild(lista_productos_carrito.firstChild);
  }
  vaciarLocalStorage(); 

  return false;
  }

      //Comprueba que haya elementos en locals
  function obtenerProductosLocalStorage(){
      let productos_localStorage; 

      //Comprobar si hay algo en locals

      if(localStorage.getItem('productos') === null){
          productos_localStorage = []
      }else{
          productos_localStorage = JSON.parse( localStorage.getItem('productos') );
      }

      return productos_localStorage;
  }



  //mostrar productos desde locals
  function leerLocalStorage(){
      let productosLocalStorage; 

      productosLocalStorage = obtenerProductosLocalStorage();

      productosLocalStorage.forEach(infoProducto => {
          const row = document.createElement('tr');

          row.innerHTML = `
              <td> <img src="${infoProducto.imagen}" width="70px">  </td>
              <td><small>${infoProducto.id_producto}</small></td>
              <td><small>${infoProducto.nombre_producto}</small></td>
              <td><small>${infoProducto.precio_producto}</small></td>
              <td>
                  <a href="#" class="borrar-curso-carrito" data-id="${infoProducto.id_producto}">X</a>
              </td>
              <td></td>
          `;
      
          lista_productos_carrito.appendChild(row);
      });
  }


  
function eliminarProductoDeCarrito(e){
      e.preventDefault();

      let producto, productoId;

      if(e.target.classList.contains('borrar-curso-carrito')){
        e.target.parentElement.parentElement.remove();
        producto = e.target.parentElement.parentElement;
        productoId = producto.querySelector('a').getAttribute('data-id');
      }

      eliminarProductoLocalStorage(productoId)
  }

  function eliminarProductoLocalStorage(producto_id){
  let productosLS; 

  productosLS = obtenerProductosLocalStorage();

  productosLS.forEach(function(productoLS, index) {
      if(productoLS.id_producto === producto_id){
          productosLS.splice(index, 1);
      }
  }); 

  localStorage.setItem('productos', JSON.stringify(productosLS) )
}


function vaciarLocalStorage(){
  localStorage.clear(); 
}
</script>

{%endblock%}