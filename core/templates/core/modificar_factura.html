{% extends 'core/base.html' %}

{% load static%}

{% load crispy_forms_tags %}

{%block css%}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-datetimepicker/2.5.20/jquery.datetimepicker.min.css" integrity="sha256-DOS9W6NR+NFe1fUhEE0PGKY/fubbUCnOfTje2JMDw3Y=" crossorigin="anonymous" >
{%endblock%}

{% block contenido%}

<div class="container mt-5 pt-5">

    <div class="row pt-5">
        <div class="col-lg-6 pt-5">

            <h3 class="my-5">Detalle Factura</h3>
            <form class="form-group" action="" method="POST">
                {% csrf_token %}

                <label for="cboEmpleado">Responsable</label>
                <select class="form-control" name="cboEmpleado" id="cboEmpleado">
                  {% for e in empleados%}
                  <option 
                  {% if e.rut_empleado == venta.EMPLEADO_RUT_EMPLEADO%}
                  {{'selected'}}
                  {%endif%}
                  value="{{e.rut_empleado}}"  id="cboEmpleado">{{e.nombres}}</option>
                  {%endfor%}
                </select>

                <hr>
                <h5>Clientes</h5>
                <hr>

                <div class="form-group">
                    <label for="id_rut_cliente text-left">Rut Cliente</label>
                    <input required type="text" class="form-control" name="id_rut_cliente" id="id_rut_cliente" value="{{cliente_actual.RUT_CLIENTE}}">
                </div>

                <table id="listado_clientes" class="table table-hover" style="width:100%">

                    <thead>
                        <tr>
                            <th>Rut Cliente</th>
                            <th>Nombre</th>
                            <th>Rut Empresa</th>
                            <th>Giro</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for c in clientes%}

                        <tr>
                            <td>{{c.rut_cliente}}</td>
                            <td>{{c.nombres}}</td>
                            <td>{{c.rut_empresa}}</td>
                            <td>{{c.giro}}</td>
                            <td>
                                <a onclick="selectCliente({{c.rut_cliente}},'{{c.giro}}')"><i class="fas fa-plus-circle"></i></a>
                            </td>
                        </tr>

                        {%endfor%}
                    </tbody>

                </table>

                


                    {{form | crispy}}


                </div>

                <div class="col-lg-6">

                    <div class="pt-4">
                        <hr class="mt-5">
                        <h5>Productos</h5>
                        <hr>
                    </div>
                    <table id="listado_productos" class="table table-hover" style="width:100%">
                        <thead class="">
                            <tr>
                                <th>SKU</th>
                                <th>Nombre</th>
                                <th>Proveedor</th>
                                <th>Valor Venta</th>
                                <th>Stock</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {%for p in productos%}
                            <tr>
                                <td>{{p.ID_PRODUCTO}}</td>
                                <td>{{p.NOMBRE}}</td>
                                <td>{{p.NOMBRE_PROVEEDOR}}</td>
                                <td>{{p.PRECIO}}</td>
                                <td>{{p.STOCK}}</td>
                                <td>
                                    
                                    <a onclick="selectProducto('{{p.ID_PRODUCTO}}','{{p.NOMBRE}}', '{{p.PRECIO}}', '{{p.STOCK}}')"><i class="fas fa-plus-circle"></i></a>
                                    
                                </td>
                            </tr>
                            {%endfor%}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th>SKU</th>
                                <th>Nombre</th>
                                <th>Proveedor</th>
                                <th>Acciones</th>
                            </tr>
                        </tfoot>
                    </table>

                    
                <div class="form-group">
                    <label for="id_producto">SKU Producto</label>
                    <input required type="text" readonly class="form-control" name="id_producto" id="id_producto">
                </div>
    
                <div class="form-group">
                    <label for="nombre_producto text-left">Nombre Producto</label>
                    <input required type="text" readonly class="form-control" name="nombre_producto" id="nombre_producto">                    
                </div>
    
                <div class="form-group">
                    <label for="id_cantidad text-left">Cantidad</label>
                    <input required type="text" class="form-control" name="id_cantidad" id="id_cantidad">
                </div>
    
                <div class="form-group">
                    <label for="id_precio_detalle text-left">Precio</label>
                    <input required type="text" class="form-control" name="id_precio_detalle" id="id_precio_detalle">
                </div>
    
                <div class="form-group">
                    <label for="id_precio text-left">Total</label>
                    <input required type="text" class="form-control" name="id_precio" id="id_precio">
                </div>

                <div class="form-group">
                    <label for="id_precio text-left">Stock</label>
                    <input required type="text" class="form-control" name="id_stock" id="id_stock">
                </div>
    
                    
                </div>

                <input class="btn btn-success" type="submit" value="Actualizar Factura">
                <a class="btn btn-danger mx-3" href="{% url 'listado_factura' %}">Descartar Cambios</a>
            </form>

    </div>


    <div class="container my-5">
        <div class="row">
            <div class="col-lg-12">
                <hr>
                <h5>Listado Productos Asociados a la factura</h5>
                <hr>
                <table id="example1" class="table table-hover" style="width:100%">
                    <thead class="">
                        <tr>
                            <th>Numero Factura</th>
                            <th>SKU Producto</th>
                            <th>Nombre</th>
                            <th>Cantidad</th>
                            <th>Precio</th>
                            <th>Total</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if productos_factura %}
                        {%for prod in productos_factura%}
                        <tr>
                            <td>{{prod.FACTURA_ID_FACTURA}}</td>
                            <td>{{prod.ID_PRODUCTO}}</td>
                            <td>{{prod.NOMBRE}}</td>
                            <td>{{prod.CANTIDAD}}</td>
                            <td>{{prod.PRECIO}}</td>
                            <td>{{prod.TOTAL}}</td>
                            
                            <td>
                                <span><a href="#"  onclick="confirmarEliminarProductoFactura('{{prod.FACTURA_ID_FACTURA }}' ,'{{prod.ID_PRODUCTO}}','{{prod.CANTIDAD}}','{{prod.TOTAL}}')" ><i class="fas fa-trash-alt text-dark"></i></a></span>
                            </td>
                        </tr>
                        {%endfor%}
                        {%endif%}
                    </tbody>
                    <tfoot>
                        <tr>
                            <th>Numero Factura</th>
                            <th>SKU Producto</th>
                            <th>Nombre</th>
                            <th>Cantidad</th>
                            <th>Precio</th>
                            <th>Total</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    
    </div>

</div>

{%endblock%}



{%block js%}
<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-datetimepicker/2.5.20/jquery.datetimepicker.full.min.js" integrity="sha256-FEqEelWI3WouFOo2VWP/uJfs1y8KJ++FLh2Lbqc8SJk=" crossorigin="anonymous"></script>  
<script>

    function confirmarEliminarProductoFactura(idFactura, idProducto, cantidad, total){
        console.log(idFactura, idProducto, cantidad, total)

        const swalWithBootstrapButtons = Swal.mixin({
        customClass: {
          confirmButton: 'btn btn-success',
          cancelButton: 'btn btn-danger'
        },
        buttonsStyling: false
      })
      
      swalWithBootstrapButtons.fire({
        title: 'Estas Seguro?',
        text: "No Puedes Revertir Esta Accion!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Si, Eliminar Producto de Factura',
        cancelButtonText: 'No, cancelar!',
        reverseButtons: true
      }).then((result) => {
        if (result.value) {
        
        window.location.href = "/eliminar_producto_factura/"+idFactura+"/"+idProducto+"/"+cantidad+"/"+total+"/";
        } else if (
          /* Read more about handling dismissals below */
          result.dismiss === Swal.DismissReason.cancel
        ) {
          swalWithBootstrapButtons.fire(
            'Cancelado',
            'El Producto No fue eliminado de factura :)',
            'error'
          )
        }
      })
    }

    $(document).ready(function(){



        $('#id_neto').attr('readonly', true);
        $('#id_total').attr('readonly', true);
        $('#id_precio').attr('readonly', true);
        $('#id_iva').attr('readonly', true);
        $('#id_sub_total').attr('readonly', true);
        $('#id_precio_detalle').attr('readonly', true);

        $('#id_rut_cliente').attr('readonly', true);
        $('#id_giro').attr('readonly', true);



    $('#listado_productos').DataTable({
    "pageLength": 2,
    "language": {
      "sProcessing": "Procesando...",
      "sLengthMenu": "Mostrar _MENU_ registros",
      "sZeroRecords": "No se encontraron resultados",
      "sEmptyTable": "Ningún dato disponible en esta tabla",
      "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
      "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
      "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
      "sInfoPostFix": "",
      "sSearch": "Buscar:",
      "sUrl": "",
      "sInfoThousands": ",",
      "sLoadingRecords": "Cargando...",
      "oPaginate": {
          "sFirst": "<span class='fa fa-angle-double-left mx-3'></span>",
          "sLast": "<span class='fa fa-angle-double-right mx-3'></span>",
          "sNext": "<span class='fa fa-angle-right'></span>",
          "sPrevious": "<span class='fa fa-angle-left'></span>"
      },
      "oAria": {
          "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
          "sSortDescending": ": Activar para ordenar la columna de manera descendente"
      }
    }
  });


  $('#listado_clientes').DataTable({
    "pageLength": 2,
    "language": {
      "sProcessing": "Procesando...",
      "sLengthMenu": "Mostrar _MENU_ registros",
      "sZeroRecords": "No se encontraron resultados",
      "sEmptyTable": "Ningún dato disponible en esta tabla",
      "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
      "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
      "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
      "sInfoPostFix": "",
      "sSearch": "Buscar:",
      "sUrl": "",
      "sInfoThousands": ",",
      "sLoadingRecords": "Cargando...",
      "oPaginate": {
          "sFirst": "<span class='fa fa-angle-double-left mx-3'></span>",
          "sLast": "<span class='fa fa-angle-double-right mx-3'></span>",
          "sNext": "<span class='fa fa-angle-right'></span>",
          "sPrevious": "<span class='fa fa-angle-left'></span>"
      },
      "oAria": {
          "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
          "sSortDescending": ": Activar para ordenar la columna de manera descendente"
      }
    }
  });


  $('#listado_facturas').DataTable({
    "pageLength": 5,
    "language": {
      "sProcessing": "Procesando...",
      "sLengthMenu": "Mostrar _MENU_ registros",
      "sZeroRecords": "No se encontraron resultados",
      "sEmptyTable": "Ningún dato disponible en esta tabla",
      "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
      "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
      "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
      "sInfoPostFix": "",
      "sSearch": "Buscar:",
      "sUrl": "",
      "sInfoThousands": ",",
      "sLoadingRecords": "Cargando...",
      "oPaginate": {
          "sFirst": "<span class='fa fa-angle-double-left mx-3'></span>",
          "sLast": "<span class='fa fa-angle-double-right mx-3'></span>",
          "sNext": "<span class='fa fa-angle-right'></span>",
          "sPrevious": "<span class='fa fa-angle-left'></span>"
      },
      "oAria": {
          "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
          "sSortDescending": ": Activar para ordenar la columna de manera descendente"
      }
    }
  });
    }); 


    function selectProducto(id, nombre, valor, stock){
            console.log(id, nombre, valor);

            if(stock == 0){
                Swal.fire({
                  icon: 'error',
                  title: 'Oops...',
                  text: 'No hay Stock de este Producto'
                })
            }else{
                $("#id_producto").val(id);
                $("#nombre_producto").val(nombre);

               $("#id_precio_detalle").val(valor);

               $("#id_stock").val(stock);
            }
    }


    $("#id_cantidad, #id_precio_detalle").change(function(){

        let cantidad, precio, total, prev_total, new_total, stock; 
        
        cantidad = $("#id_cantidad").val(); 
        cantidad = cantidad === "" ? 0 : +cantidad;
        cantidad = cantidad<0 ? 0 : cantidad;

        stock = $("#id_stock").val();

        if(cantidad > stock){
            Swal.fire({
                  icon: 'error',
                  title: 'Oops...',
                  text: 'La Cantidad Ingresada supera el stock disponible'
            })
        }else{
            
        precio = $("#id_precio_detalle").val()
        precio = precio === "" ? 0 : +precio;
        precio = precio<0 ? 0 : precio;

        total = precio * cantidad; 
        prev_total = $("#id_sub_total").val()

        totalActual = parseInt(prev_total)  + total;
        $("#id_sub_total").val(totalActual); 

        iva = totalActual * 0.19; 

        total_final = totalActual + iva;  

        $("#id_iva").val(iva);
        $("#id_precio").val(total);
        $("#id_total").val(total_final);

        console.log(total);
        }
    })


    function selectCliente(rut, giro){
        $("#id_rut_cliente").val(rut)
        $("#id_giro").val(giro)
    }

</script>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
<script src="{% static 'core/js/confirmacion.js'%}"></script>
{%endblock%}